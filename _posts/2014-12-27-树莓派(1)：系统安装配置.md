# 树莓派(1)：系统安装配置

# 目录

<ol><script src="http://code.jquery.com/jquery-1.7.2.min.js"></script><script type="text/javascript"> $(document).ready(function(){ $("h2,h3,h4,h5,h6").each(function(i,item){ var tag = $(item).get(0).localName; $(item).attr("id","wow"+i); $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>'); $(".newh2").css("margin-left",0); $(".newh3").css("margin-left",20); $(".newh4").css("margin-left",40); $(".newh5").css("margin-left",60); $(".newh6").css("margin-left",80); }); }); </script><div id="category"></div></ol>

## 0. 前言

本文基于：

* 硬件
    * Raspbeery Pi B+ model
    * USB无线网卡
* 系统：Archlinux ARM

树莓派已经属于上一代ARM开源硬件了，在ARMv8已经推出，ARMv7是主流的时代。其性能太低了：

* CPU(ARMv6)：700MHZ
* RAM：512MB

这样的配置只能勉强运行轻量级的X桌面管理器，如OpenBox、Lxde、Xfce之类的；运行浏览器会有明显的卡顿；无法运行FlashPlayer，因为Flash对CPU要求很高。

但树莓派B+ model接口还算丰富，仍然有一定价值。

## 1. 安装操作系统

在支持Raspbeery Pi几种操作系统中，我选择Archlinux ARM，原因：

1. 安装简单。
2. 轻量级，资源占用较少，对Raspbeery Pi这样配置很弱的硬件很重要。
3. 源里包全面且版本新。
4. 滚动升级。
5. 配置方便。

官方网站：[Archlinux ARM](http://archlinuxarm.org/)

### 1.1 安装

需要准备一张至少4G的micro SD卡（TF卡）

按照官方提供的[安装方法](http://archlinuxarm.org/platforms/armv6/raspberry-pi)。

### 1.2 另一种安装方案

官方提供的安装是按最简单的分区方案，而且没有swap分区；简单的分区方案：

```
$ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
mmcblk0     179:0    0 29.8G  0 disk
├─mmcblk0p1 179:1    0  100M  0 part /boot
└─mmcblk0p2 179:2    0 29.7G  0 part /
```

如果SD卡足够大，可以选用稍复杂的分区安装方案：

1. 开始对SD卡进行分区：

	```
	cfdisk /dev/mmcblkX
	```
2. 分区方案：

	```
	mmcblkXp1 mmcblkXp2   mmcblkXp3     mmcblkXp4
	+--------+---------+-------------+--------------
	|  100M  |  1024M  |    2048M    |    others
	+--------+---------+-------------+--------------
	| fat32  |  swap   |    ext4     |    ext4
	                   |    btrfs    |    btrfs
	```

	> 除了/boot swap其他分区可选ext4/btrfs。

3. 格式化、挂载/boot
	
	```
	mkfs.vfat /dev/mmcblkXp1
	mkdir boot
	mount /dev/mmcblkXp1 boot
	```
4. 格式化swap
	
	```
	mkswap /dev/mmcblkXp2
	```
5. 格式化、挂载/

	```
	mkfs.ext4 /dev/mmcblkXp3
	mkdir root
	mount /dev/mmcblkXp3 root
	```
6. 下载并解压根文件系统

	```
	wget http://archlinuxarm.org/os/ArchLinuxARM-rpi-latest.tar.gz
	bsdtar -xpf ArchLinuxARM-rpi-latest.tar.gz -C root
	sync
	```
7. 移动boot文件到第一个分区中（就是SD卡上的/boot分区）

	```
	mv root/boot/* boot
	```

8. 配置分区表

	编辑/mnt/root/etc/fstab
	
	```
	#
	# /etc/fstab: static file system information
	#
	# <file system>	<dir>	<type>	<options>	<dump>	<pass>
	/dev/mmcblk0p1  /boot   vfat    defaults        0       0
	/dev/mmcblk0p2   swap   swap    defaults        0       0
	/dev/mmcblk0p3   /      ext4    defaults        0       1
	/dev/mmcblk0p4   /home  ext4    defaults        0       1
	```

9. 结束安装：

	取消挂载
	
	```
	umount boot root
	```
	
	取出SD卡，插入Raspbeery Pi的SD卡插槽，然后接入网线和micro USB电源；
	
	通过ssh登陆系统，默认账号密码均为：root


## 2. 基本配置

__！先修改root密码__

```
passwd
```

### 2.1 创建用户

创建用户：

```
useradd -G wheel -m -s /usr/bin/bash YourUserName
```

修改密码：

```
passwd YourUserName
```

*如果你喜欢更好shell的: fish*

```
pacman -S fish
chsh -s /usr/bin/fish YourUserName
```

安装配置sudo：

```
pacman -S sudo
echo "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
```

> 以上配置表示所有wheel组的用户都可无密码执行sudo；可能不太安全，可酌情修改。

结束：

```
exit
```

重新用新建的账户登录；尽量不要用root账号登录。

### 2.2 配置locale和localtime

```
echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
```

> 以上配置了中文简体和英语。

设置语言为简体中文：

```
echo "LANG=zh_CN.UTF8" >> ~/.bashrc
```

设置时区:

```
ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
```

查看时间日期是否正常：

```
date
```

### 2.3 安装配置vim

```
pacman -S vim
curl 'https://raw.githubusercontent.com/emptyland/scripts/master/conf/comm/vimrc' > /etc/vimrc
```

> 以上使用我的vim配置进行全局配置。
> 如果不希望全局配置，可以将vimrc文件放到: `~/.vimrc`

### 2.4 配置pacman

先进行更新系统：

```
pacman -Syu
```

使用wget做pacman的下载器：

```
pacman -S wget
echo "XferCommand = /usr/bin/wget --passive-ftp -c -O %o %u" > /etc/pacman.conf
```

使用较快的源：

编辑`/etc/pacman.d/mirrorlist`
	
添加以下源到文件头部：

* 中国科技大学：`Server = http://mirrors.ustc.edu.cn/archlinuxarm/$arch/$repo`

官方源列表：[http://archlinuxarm.org/about/mirrors](http://archlinuxarm.org/about/mirrors)

### 2.5 每日自动更新系统

1. 需要先安装crond
	
	```
	pacman -S cronie
	systemctl enable cronie
	systemctl start cronie
	```
2. 配置crond

	```
	sed -i -e "s/^ExecStart=.*\$/ExecStart=\/usr\/bin\/crond -n -s/" /usr/lib/systemd/system/cronie.service
	```

3. 设置crontab

	```
	echo '0 0 * * * root pacman -Syu --noconfirm' > /etc/cron.d/daily_upgrade
	chown root:root /etc/cron.d/daily_upgrade
	chmod 644 /etc/cron.d/daily_upgrade
	```

	> 以上设置每天00:00更新整个系统。 

如何关闭自动更新？

只要删除crontab就可以了：`rm /etc/cron.d/daily_upgrade`

如何排查问题？

* 查看cronie日志：`sudo journalctl -u cronie`
* 查看pacman日志：`less /var/log/pacman.log`

### 2.6 ssh免密码登录

如果没有`~/.ssh`文件夹，需要创建一个：

```
mkdir ~/.ssh
chmod 700 .ssh
```

将终端机的公钥放到`~/.ssh/authorized_keys`中，一个公钥行。

从有对应公钥的私钥的终端登录Raspbeery Pi可以免密码了。

```C
int main(int argc, char *argv[]) {
	return 0;
}
```

